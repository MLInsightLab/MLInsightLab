version: '3.7'

services:
  jupyter:
    restart: always
    build: ./jupyterhub
    image: jupyter
    container_name: jupyter
    ports:
      - "8000:8000"
    volumes:
      - notebooks:/home
      - jh_db:/jh_db
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:2244

  mlflow:
    restart: always
    build: ./mlflow
    image: mlflow
    container_name: mlflow
    ports:
      - "2244:2244"
    volumes:
      - mlflow_backend_storage:/backend_uri
      - mlflow_artifact_storage:/artifact_store
    environment:
      - MLFLOW_BACKEND_STORE_URI=sqlite:////backend_uri/backend_store.sqlite
      - MLFLOW_TRACKING_URI=http://mlflow:2244
      - MLFLOW_TRACKING_ARTIFACT_STORE=file:///artifact_store
    entrypoint: /bin/sh -c "mlflow server --artifacts-destination file:///artifact_store --host 0.0.0.0 --port 2244"

volumes:
    mlflow_backend_storage:
    mlflow_artifact_storage:
    notebooks:
    jh_db: